{% extends "base.html" %}
{% block title %}{{ c.code }} | Inventario{% endblock %}

{% block content %}
  <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">{{ c.code }}</h2>
      <div style="color:#666; margin-top:6px;">
        {{ c.size }}{% if c.year %} · {{ c.year }}{% endif %}
        · {% if c.is_in_yard %}<b style="color:#137333;">En patio</b>{% else %}<b style="color:#555;">Fuera de patio</b>{% endif %}
      </div>
    </div>

    <div style="display:flex; gap:10px;">
      <a href="{{ url_for('inventory.inventory_index') }}"
         style="padding:8px 10px; border:1px solid #ddd; border-radius:10px; text-decoration:none; color:#111; font-weight:800;">
        ← Volver
      </a>
    </div>
  </div>

  <div style="margin-top:12px; padding:12px; border:1px solid #eee; border-radius:12px;">
    <div style="font-weight:900; margin-bottom:6px;">Posición actual</div>
    {% if current_pos %}
      <div>{{ current_pos.bay_code }} · F{{ "%02d"|format(current_pos.depth_row) }} · N{{ current_pos.tier }}</div>
    {% else %}
      <div style="color:#666;">—</div>
    {% endif %}
    {% if c.status_notes %}
      <div style="margin-top:10px; color:#333;"><b>Notas:</b> {{ c.status_notes }}</div>
    {% endif %}
  </div>

  <h3 style="margin-top:18px; margin-bottom:8px;">Fotos</h3>
  <div style="color:#666; font-size:13px; margin-bottom:10px;">
    Mostrando solo imágenes válidas. Errores de carga se listan abajo.
  </div>

  {% if not movements %}
    <div style="color:#666;">Este contenedor no tiene movimientos registrados.</div>
  {% endif %}

  {# ====== GALERÍA (solo fotos válidas) ====== #}
  {% set any_valid_photo = false %}
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    {% for mv in movements %}
      {% set photos = photos_by_mv.get(mv.id, []) %}
      {% for ph in photos %}
        {% set u = (ph.url or "") %}
        {% set is_http = u.startswith("http://") or u.startswith("https://") %}
        {% set is_error = (ph.photo_type == "UPLOAD_ERROR") or (not is_http) %}
        {% if not is_error %}
          {% set any_valid_photo = true %}
          <a href="{{ u }}" target="_blank"
             title="{{ mv.movement_type }} · {{ mv.occurred_at }}"
             style="display:inline-block; border:1px solid #ddd; border-radius:12px; overflow:hidden; width:190px; text-decoration:none; color:#111; background:#fff;">
            <img src="{{ u }}" alt="{{ ph.photo_type }}"
                 style="width:190px; height:140px; object-fit:cover; display:block;">
            <div style="padding:8px 10px;">
              <div style="font-weight:900; font-size:12px; margin-bottom:4px;">{{ ph.photo_type }}</div>
              <div style="font-size:11px; color:#666;">
                {{ mv.movement_type }} · {{ mv.occurred_at }}
              </div>
            </div>
          </a>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>

  {% if not any_valid_photo %}
    <div style="margin-top:8px; color:#666;">Aún no hay fotos válidas para mostrar.</div>
  {% endif %}

  {# ====== ERRORES (no rompen la página) ====== #}
  <h3 style="margin-top:18px; margin-bottom:8px;">Log de errores de fotos</h3>

  {% set any_error = false %}
  {% for mv in movements %}
    {% set photos = photos_by_mv.get(mv.id, []) %}
    {% for ph in photos %}
      {% set u = (ph.url or "") %}
      {% set is_http = u.startswith("http://") or u.startswith("https://") %}
      {% set is_error = (ph.photo_type == "UPLOAD_ERROR") or (not is_http) %}
      {% if is_error %}
        {% set any_error = true %}
        <div style="margin-top:8px; border:1px solid #f3d5d5; background:#fff5f5; padding:10px 12px; border-radius:12px;">
          <div style="font-weight:900; color:#b3261e;">
            {{ mv.movement_type }} · {{ mv.occurred_at }} — {{ ph.photo_type }}
          </div>
          <div style="margin-top:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px; color:#333; white-space:pre-wrap;">
            {{ u }}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% endfor %}

  {% if not any_error %}
    <div style="color:#666;">Sin errores registrados.</div>
  {% endif %}
{% endblock %}