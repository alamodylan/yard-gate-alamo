{% extends "base.html" %}
{% block title %}Ticket - Yard Gate Alamo{% endblock %}

{% block content %}
<div class="card card-pad ticket-card" style="max-width:820px;">
  <!-- Header -->
  <div class="ticket-head">
    <div class="ticket-brand">
      <img class="ticket-logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="Alamo Terminales Marítimas">
      <div>
        <div class="ticket-title">Yard Gate Alamo</div>
        <div class="ticket-sub">Ticket de Movimiento {% if is_reprint %}(Reimpresión){% endif %}</div>
      </div>
    </div>

    <div class="ticket-right">
      <div class="badge {% if mv.movement_type == 'GATE_IN' %}success{% elif mv.movement_type=='GATE_OUT' %}danger{% else %}muted{% endif %}">
        {{ mv.movement_type }}
      </div>
      <div class="ticket-dt">
        <div class="dt-date">{{ mv.occurred_at|dt_cr("%d/%m/%Y") }}</div>
        <div class="dt-time">{{ mv.occurred_at|dt_cr("%H:%M") }}</div>
      </div>
    </div>
  </div>

  <div class="ticket-grid">
    <div class="ticket-kv">
      <div class="ticket-k">Contenedor</div>
      <div class="ticket-v">{{ c.code }}</div>

      <div class="ticket-m">
        <b>{{ c.size }}</b>
        {% if c.year %} · Año {{ c.year }}{% endif %}
      </div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Ubicación</div>
      <div class="ticket-v">
        {% if mv.bay_code %}
          {{ mv.bay_code }}
          {% if mv.depth_row %} · F{{ "%02d"|format(mv.depth_row) }}{% endif %}
          {% if mv.tier %} · N{{ mv.tier }}{% endif %}
        {% else %}
          —
        {% endif %}
      </div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Chofer</div>
      <div class="ticket-v">{{ mv.driver_name or "—" }}</div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Placa</div>
      <div class="ticket-v">{{ mv.truck_plate or "—" }}</div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Cédula</div>
      <div class="ticket-v">{{ mv.driver_id_doc or "—" }}</div>
    </div>
  </div>

  {% if mv.notes %}
    <div class="ticket-notes">
      <div class="ticket-k">Observaciones</div>
      <div class="ticket-notes-box">{{ mv.notes }}</div>
    </div>
  {% endif %}

  <!-- Firma -->
  <div class="ticket-sign">
    <div class="ticket-k">Firma transportista</div>
    <div class="sign-box"></div>

    <div class="sign-row">
      <div class="sign-field">
        <div class="ticket-k">Nombre</div>
        <div class="sign-line"></div>
      </div>
      <div class="sign-field">
        <div class="ticket-k">Cédula</div>
        <div class="sign-line"></div>
      </div>
    </div>

    <div style="height:8px;"></div>
  </div>

  <!-- ✅ Cola extra para que NO se corte Nombre/Cédula (solo imprime) -->
  <div class="print-spacer"></div>

  <!-- ✅ Payload visible (debug) -->
  <div class="payload-box">
    <div class="ticket-k" style="margin-bottom:8px;">Payload enviado a impresión (Epson / Agent)</div>
    <pre class="payload-pre">{{ payload }}</pre>
  </div>

  <!-- ✅ JSON seguro para JS (VS Code NO lo marca como error) -->
  <script type="application/json" id="ticketPayloadJson">{{ payload|tojson }}</script>
  <script type="application/json" id="ticketRequestedByJson">
    {{ (current_user.username if current_user else "usuario")|tojson }}
  </script>

  <!-- Botones -->
  <div class="ticket-actions">
    <button class="btn primary" onclick="window.print()">Imprimir (Navegador)</button>

    <button
      class="btn"
      type="button"
      data-movement-id="{{ mv.id }}"
      onclick="printDirect(this)">
      Imprimir (Epson)
    </button>

    <a class="btn" href="{{ url_for('yard.map_view') }}">Volver al mapa</a>
  </div>
</div>

<script>
function readJsonScript(id){
  const el = document.getElementById(id);
  if(!el) return null;
  try { return JSON.parse(el.textContent || "null"); } catch { return null; }
}

async function printDirect(btn){
  const movementId = btn.dataset.movementId;
  if(!movementId){
    alert("ID de movimiento inválido");
    return;
  }
  if(!confirm("¿Enviar ticket a la impresora Epson?")) return;

  const ticketText = readJsonScript("ticketPayloadJson");
  const requestedBy = readJsonScript("ticketRequestedByJson") || "usuario";

  if(!ticketText){
    alert("No se pudo construir el payload del ticket.");
    return;
  }

  btn.disabled = true;

  try {
    const r = await fetch("/api/print/jobs", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({
        payload_text: ticketText,
        ticket_id: movementId,
        requested_by: requestedBy,
        request_origin: "android"
      })
    });

    const data = await r.json().catch(() => ({}));
    if(!r.ok){
      alert(data.error || "Error al enviar a impresión");
      return;
    }

    alert("Ticket enviado a cola de impresión ✅");

  } catch (e){
    alert("No se pudo conectar con el servidor de impresión");
  } finally {
    btn.disabled = false;
  }
}
</script>

<style>
/* ===== Ticket layout ===== */
.ticket-card{ overflow:hidden; }
.ticket-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:14px;
  padding-bottom:12px;
  border-bottom:1px solid var(--border);
}
.ticket-brand{ display:flex; gap:12px; align-items:center; }
.ticket-logo{
  height:44px; width:auto; object-fit:contain;
  border-radius:10px;
}
.ticket-title{ font-weight:950; font-size:18px; }
.ticket-sub{ color:var(--muted); font-weight:800; font-size:12px; margin-top:2px; }

.ticket-right{ text-align:right; display:grid; gap:6px; justify-items:end; }
.ticket-dt{ font-weight:900; color:rgba(229,231,235,.92); }

.ticket-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
  padding-top:14px;
}
@media (max-width: 760px){
  .ticket-grid{ grid-template-columns: 1fr; }
  .ticket-right{ justify-items:start; text-align:left; }
  .ticket-head{ align-items:flex-start; }
}

.ticket-k{ color:var(--muted); font-weight:900; font-size:12px; }
.ticket-v{ font-weight:950; font-size:18px; margin-top:2px; }
.ticket-m{ color:rgba(229,231,235,.82); font-weight:900; font-size:13px; margin-top:4px; }

.ticket-notes{ margin-top:14px; }
.ticket-notes-box{
  margin-top:8px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:14px;
  background:rgba(255,255,255,.03);
  font-weight:850;
  white-space:pre-wrap;
}

.ticket-sign{ margin-top:14px; }
.sign-box{
  margin-top:8px;
  border:1px solid var(--border);
  border-radius:14px;
  height:78px;
  background:rgba(255,255,255,.02);
}
.sign-row{
  margin-top:12px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
}
.sign-line{
  margin-top:8px;
  height:18px;
  border-bottom:1px solid rgba(229,231,235,.45);
}

.print-spacer{ display:none; } /* solo se activa al imprimir */

.payload-box{
  margin-top:14px;
  border-top:1px solid var(--border);
  padding-top:14px;
}
.payload-pre{
  white-space:pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  overflow:auto;
}

.ticket-actions{
  margin-top:14px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* ===== Print rules (NAVEGADOR) ===== */
@media print {
  .topbar,
  .ticket-actions,
  .flash-stack{
    display: none !important;
  }

  .payload-box { display:none !important; }

  @page{
    size: 80mm auto;
    margin: 0;
  }

  body {
    background:#fff !important;
    color:#000 !important;
    width:80mm;
    margin:0 !important;
  }

  .card{
    box-shadow:none !important;
    border:0 !important;
  }

  /* ✅ Header térmico: logo arriba y centrado */
  .ticket-head{
    display:block !important;
    text-align:center !important;
    padding-bottom:10px !important;
  }
  .ticket-brand{
    display:block !important;
  }
  .ticket-logo{
    display:block !important;
    margin:0 auto 6px auto !important;
    height:auto !important;
    width:34mm !important;      /* ajusta: 30–45mm */
    border-radius:0 !important;
  }
  .ticket-right{
    margin-top:6px !important;
    text-align:center !important;
    justify-items:center !important;
  }

  .ticket-sub, .ticket-k { color:#333 !important; }
  .ticket-notes-box, .sign-box { background:#fff !important; border:1px solid #bbb !important; }

  .ticket-v{ font-size:16px !important; }
  .ticket-title{ font-size:16px !important; }

  .ticket-dt{
    font-size: 15px !important;
    font-weight: 950 !important;
    color:#000 !important;
    letter-spacing: .2px !important;
  }

  .ticket-m{
    font-size: 13px !important;
    font-weight: 950 !important;
    color:#000 !important;
    margin-top: 2px !important;
    line-height: 1.2 !important;
  }

  .ticket-k{
    font-size: 12px !important;
    font-weight: 900 !important;
    color:#000 !important;
  }

  /* ✅ Cola extra al final para evitar cortes */
  .print-spacer{
    display:block !important;
    height:18mm !important;  /* sube a 25mm si aún corta */
  }

  *{
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
}
</style>
{% endblock %}





