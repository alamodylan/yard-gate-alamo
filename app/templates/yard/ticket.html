{% extends "base.html" %}
{% block title %}Ticket - Yard Gate √Ålamo{% endblock %}

{% block content %}
<div class="card card-pad ticket-card" style="max-width:820px;">
  <!-- Header -->
  <div class="ticket-head">
    <div class="ticket-brand">
      <img class="ticket-logo" src="{{ url_for('static', filename='img/logo.png') }}" alt="√Ålamo Terminales Mar√≠timas">
      <div>
        <div class="ticket-title">Yard Gate √Ålamo</div>
        <div class="ticket-sub">Ticket de Movimiento {% if is_reprint %}(Reimpresi√≥n){% endif %}</div>
      </div>
    </div>

    <div class="ticket-right">
      <div class="badge {% if mv.movement_type == 'GATE_IN' %}success{% elif mv.movement_type=='GATE_OUT' %}danger{% else %}muted{% endif %}">
        {{ mv.movement_type }}
      </div>
      <div class="ticket-dt">{{ mv.occurred_at|dt_cr("%d/%m/%Y %H:%M") }}</div>
    </div>
  </div>

  <div class="ticket-grid">
    <div class="ticket-kv">
      <div class="ticket-k">Contenedor</div>
      <div class="ticket-v">{{ c.code }}</div>
      <div class="ticket-m">{{ c.size }}{% if c.year %} ¬∑ A√±o: {{ c.year }}{% endif %}</div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Ubicaci√≥n</div>
      <div class="ticket-v">
        {% if mv.bay_code %}
          {{ mv.bay_code }} ¬∑ F{{ "%02d"|format(mv.depth_row or 0) }} ¬∑ N{{ mv.tier or 0 }}
        {% else %}
          ‚Äî
        {% endif %}
      </div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Chofer</div>
      <div class="ticket-v">{{ mv.driver_name or "‚Äî" }}</div>
    </div>

    <div class="ticket-kv">
      <div class="ticket-k">Placa</div>
      <div class="ticket-v">{{ mv.truck_plate or "‚Äî" }}</div>
    </div>
  </div>

  {% if mv.notes %}
    <div class="ticket-notes">
      <div class="ticket-k">Observaciones</div>
      <div class="ticket-notes-box">{{ mv.notes }}</div>
    </div>
  {% endif %}

  <!-- Firma -->
  <div class="ticket-sign">
    <div class="ticket-k">Firma transportista</div>
    <div class="sign-box"></div>

    <div class="sign-row">
      <div class="sign-field">
        <div class="ticket-k">Nombre</div>
        <div class="sign-line"></div>
      </div>
      <div class="sign-field">
        <div class="ticket-k">C√©dula</div>
        <div class="sign-line"></div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Payload (solo para ver / debug en pantalla, NO se imprime por navegador) -->
  <div class="payload-box">
    <div class="ticket-k" style="margin-bottom:8px;">Payload enviado a impresi√≥n (Epson / Agent)</div>
    <pre class="payload-pre">{{ payload }}</pre>
  </div>

  <!-- Botones -->
  <div class="ticket-actions">
    <button class="btn primary" onclick="window.print()">Imprimir (Navegador)</button>

    <button
      class="btn"
      type="button"
      data-movement-id="{{ mv.id }}"
      onclick="printDirect(this)">
      Imprimir (Epson)
    </button>

    <a class="btn" href="{{ url_for('yard.map_view') }}">Volver al mapa</a>
  </div>
</div>

<script>
async function printDirect(btn){
  const movementId = btn.dataset.movementId;
  if(!movementId){
    alert("ID de movimiento inv√°lido");
    return;
  }
  if(!confirm("¬øEnviar ticket a la impresora Epson?")) return;

  try {
    const r = await fetch(`/print/${movementId}`, {
      method: "POST",
      headers: { "Accept": "application/json" }
    });
    const data = await r.json();
    if(!r.ok){
      alert(data.error || "Error al imprimir");
      return;
    }
    alert("Ticket enviado a la impresora Epson ‚úÖ");
  } catch (e){
    alert("No se pudo conectar con el servicio de impresi√≥n");
  }
}
</script>

<style>
/* ===== Ticket layout ===== */
.ticket-card{ overflow:hidden; }
.ticket-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:14px;
  padding-bottom:12px;
  border-bottom:1px solid var(--border);
}
.ticket-brand{ display:flex; gap:12px; align-items:center; }
.ticket-logo{
  height:44px; width:auto; object-fit:contain;
  border-radius:10px;
}
.ticket-title{ font-weight:950; font-size:18px; }
.ticket-sub{ color:var(--muted); font-weight:800; font-size:12px; margin-top:2px; }

.ticket-right{ text-align:right; display:grid; gap:6px; justify-items:end; }
.ticket-dt{ font-weight:900; color:rgba(229,231,235,.92); }

.ticket-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
  padding-top:14px;
}
@media (max-width: 760px){
  .ticket-grid{ grid-template-columns: 1fr; }
  .ticket-right{ justify-items:start; text-align:left; }
  .ticket-head{ align-items:flex-start; }
}

.ticket-k{ color:var(--muted); font-weight:900; font-size:12px; }
.ticket-v{ font-weight:950; font-size:18px; margin-top:2px; }
.ticket-m{ color:rgba(229,231,235,.78); font-weight:800; font-size:12px; margin-top:4px; }

.ticket-notes{ margin-top:14px; }
.ticket-notes-box{
  margin-top:8px;
  padding:10px 12px;
  border:1px solid var(--border);
  border-radius:14px;
  background:rgba(255,255,255,.03);
  font-weight:850;
  white-space:pre-wrap;
}

.ticket-sign{ margin-top:14px; }
.sign-box{
  margin-top:8px;
  border:1px solid var(--border);
  border-radius:14px;
  height:78px;
  background:rgba(255,255,255,.02);
}
.sign-row{
  margin-top:12px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:14px;
}
.sign-line{
  margin-top:8px;
  height:18px;
  border-bottom:1px solid rgba(229,231,235,.45);
}

.payload-box{
  margin-top:14px;
  border-top:1px solid var(--border);
  padding-top:14px;
}
.payload-pre{
  white-space:pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  overflow:auto;
}

.ticket-actions{
  margin-top:14px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* ===== Print rules (NAVEGADOR) ===== */
@media print {
  .topbar,
  .ticket-actions,
  .flash-stack {   /* üî• esto oculta el mensaje verde */
    display: none !important;
  }

  /* üî• Esto es lo que quita el cuadro duplicado */
  .payload-box { display:none !important; }

  /* Fondo blanco para impresi√≥n */
  body { background:#fff !important; color:#000 !important; }
  .card{ box-shadow:none !important; border:0 !important; }
  .ticket-sub, .ticket-k { color:#333 !important; }
  .ticket-notes-box, .sign-box { background:#fff !important; border:1px solid #bbb !important; }

@media print {
  body {
    width: 80mm;
    margin: 0 auto;
  }
}
}
</style>
{% endblock %}



