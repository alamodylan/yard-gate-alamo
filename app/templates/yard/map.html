{% extends "base.html" %}
{% block title %}Mapa - Yard Gate √Ålamo{% endblock %}

{% block content %}
<div class="card card-pad">
  <h2 style="margin:0;">Mapa de Predio</h2>
  <p class="card-sub" style="margin-top:6px;">
    PC: selecciona contenedor ‚Üí arrastra ‚Üí bloque ‚Üí estiba ‚Üí fila ‚Üí confirmar.
    <br>
    Tablet/Celular: selecciona contenedor ‚Üí toca bloque ‚Üí toca estiba ‚Üí toca fila ‚Üí confirmar.
  </p>
</div>

<div class="yard-layout" style="margin-top:14px;">
  <!-- =========================
       LEFT: Bandeja contenedores
       ========================= -->
  <aside class="yard-panel card card-pad">
    <div class="yard-panel-head">
      <div>
        <div class="card-title" style="margin:0;">Contenedores en patio</div>
        <div class="card-sub" style="margin-top:6px;">Busca, selecciona y col√≥calos en el mapa.</div>
      </div>

      <button type="button" id="refreshContainersBtn" class="btn small">
        Refrescar
      </button>
    </div>

    <label for="containerSearch">Buscar</label>
    <input id="containerSearch" type="text" placeholder="Ej: CSNU-123456-7" />

    <div id="touchHint" class="hint hidden" style="margin-top:10px;">
      üìå Modo tablet/celular: toca un contenedor para seleccionarlo y luego toca el bloque/estiba/fila.
    </div>

    <div id="selectedContainerBar" class="selected-bar hidden" style="margin-top:12px;">
      <div class="yard-selected-row">
        <div>
          <div class="hint" style="margin:0;">Seleccionado</div>
          <div id="selectedContainerText" style="font-weight:950;">‚Äî</div>
        </div>
        <button type="button" id="clearSelectedBtn" class="btn small">
          Quitar
        </button>
      </div>
    </div>

    <div id="containersList" class="containers-list" style="margin-top:12px;">
      <div class="hint">Cargando contenedores‚Ä¶</div>
    </div>
  </aside>

  <!-- =========================
       RIGHT: Patio Visual
       ========================= -->
  <section class="yard-mapwrap card card-pad">
    <!-- Toolbar / Breadcrumb -->
    <div class="yard-toolbar yard-toolbar-row">
      <div class="yard-toolbar-left">
        <button type="button" id="yardBackBtn" class="btn small hidden">
          ‚¨Ö Atr√°s
        </button>

        <div class="yard-breadcrumb">
          <b id="yardCrumbLevel">Bloques</b>
          <span id="yardCrumbDetail" class="yard-crumb-detail"></span>
        </div>
      </div>

      <div class="yard-toolbar-right">
        <span class="hint" style="margin:0;">Contenedor:</span>
        <b id="yardActiveContainer">‚Äî</b>
      </div>
    </div>

    <!-- Mapa -->
    <div class="yard-canvas" style="margin-top:12px; position:relative;">
      <!-- Chip flotante del contenedor seleccionado -->
      <div id="dragChip"
           class="yard-dragchip hidden"
           draggable="true"
           style="position:absolute; top:10px; left:10px; z-index:5;">
        <span id="dragChipCode">‚Äî</span>
      </div>

      <!-- SVG principal -->
      <svg id="yardSvg"
           viewBox="0 0 1100 520"
           style="width:100%; height:520px; border:1px solid rgba(148,163,184,.18); border-radius:18px; background:rgba(255,255,255,.02);">
      </svg>

      <!-- Panel Estibas -->
      <div id="stacksPanel" class="yard-overlay hidden">
        <div class="yard-overlay-card">
          <div class="yard-overlay-head">
            <div>
              <div class="card-title" style="margin:0;">
                Estibas del bloque <span id="stacksBlockCode">‚Äî</span>
              </div>
              <div class="card-sub" style="margin-top:6px;">Verde = disponible ¬∑ Rojo = lleno</div>
            </div>

            <button type="button" id="stacksCloseBtn" class="btn small">
              Cerrar
            </button>
          </div>

          <div id="stacksGrid" class="yard-grid" style="margin-top:12px;"></div>

          <!-- Confirmaci√≥n (reubicada para usarla desde Estibas / Rack) -->
          <div id="confirmBar" class="hidden" style="margin-top:12px;">
            <div class="yard-confirm-row">
              <div style="font-size:13px;">
                Selecci√≥n: <b id="suggestedSlot">‚Äî</b>
              </div>

              <div style="display:flex; gap:10px; align-items:center;">
                <button type="button" id="confirmPlacementBtn" class="btn success">
                  Confirmar
                </button>
                <button type="button" id="cancelPlacementBtn" class="btn">
                  Cancelar
                </button>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Tip: toca un contenedor para seleccionarlo y luego toca un espacio <b>verde</b> para elegir destino.
          </div>
        </div>
      </div>

      <!-- Panel Filas (se mantiene por compatibilidad / fallback) -->
      <div id="rowsPanel" class="yard-overlay hidden">
        <div class="yard-overlay-card">
          <div class="yard-overlay-head">
            <div>
              <div class="card-title" style="margin:0;">
                Filas ¬∑ Bloque <span id="rowsBlockCode">‚Äî</span> ¬∑ Estiba <span id="rowsStackCode">‚Äî</span>
              </div>
              <div class="card-sub" style="margin-top:6px;">
                Rojo = fila con 4 niveles ¬∑ Verde = admite m√°s
              </div>
            </div>

            <button type="button" id="rowsCloseBtn" class="btn small">
              Cerrar
            </button>
          </div>

          <div id="rowsGrid" class="yard-grid" style="margin-top:12px;"></div>

          <div class="hint" style="margin-top:10px;">
            Tip: al soltar en una fila verde, el sistema asigna el <b>nivel exacto</b> autom√°ticamente.
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
  window.YARD_INIT = {
    block: "{{ selected_block }}",
  };
</script>
<script src="{{ url_for('static', filename='js/yard_map.js') }}"></script>
{% endblock %}


