{% extends "base.html" %}
{% block title %}Mapa - Yard Gate Ãlamo{% endblock %}
{% block content %}
<h2>Mapa de Predio</h2>

<div class="yard-layout">
  <!-- ===== LEFT: Bandeja contenedores ===== -->
  <div class="yard-panel card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
      <div style="font-weight:700;">Contenedores en patio</div>
      <button type="button" id="refreshContainersBtn" style="margin-top:0;">Refrescar</button>
    </div>

    <label style="margin-top:10px;">Buscar</label>
    <input id="containerSearch" type="text" placeholder="Ej: CSNU-123456-7" />

    <div id="touchHint" class="hint hidden" style="margin-top:10px;">
      ğŸ“Œ Modo tablet/celular: toca un contenedor para seleccionarlo y luego toca el bloque/estiba/fila.
    </div>

    <div id="selectedContainerBar" class="selected-bar hidden">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
          <div style="font-size:12px; color:#555;">Seleccionado</div>
          <div id="selectedContainerText" style="font-weight:700;">â€”</div>
        </div>
        <button type="button" id="clearSelectedBtn" style="margin-top:0; background:#111;">Quitar</button>
      </div>
    </div>

    <div id="containersList" class="containers-list" style="margin-top:10px;">
      <div class="hint">Cargando contenedoresâ€¦</div>
    </div>
  </div>

  <!-- ===== RIGHT: Patio Visual ===== -->
  <div class="yard-mapwrap card" style="max-width: 1100px;">
    <!-- Header / Breadcrumb -->
    <div class="yard-toolbar" style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <button type="button" id="yardBackBtn" class="hidden" style="margin-top:0;">â¬… AtrÃ¡s</button>

        <div class="yard-breadcrumb" style="font-size:13px; color:#333;">
          <b id="yardCrumbLevel">Bloques</b>
          <span id="yardCrumbDetail" style="color:#666; margin-left:6px;"></span>
        </div>
      </div>

      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <span style="font-size:12px; color:#666;">Contenedor:</span>
        <b id="yardActiveContainer">â€”</b>
      </div>
    </div>

    <!-- Mapa -->
    <div style="margin-top:12px; position:relative;">
      <!-- â€œChipâ€ flotante del contenedor seleccionado (para que se vea arrastrable) -->
      <div id="dragChip" class="yard-dragchip hidden" draggable="true"
           style="position:absolute; top:10px; left:10px; z-index:5;">
        <span id="dragChipCode">â€”</span>
      </div>

      <!-- SVG principal: SOLO BLOQUES al inicio -->
      <svg id="yardSvg"
           viewBox="0 0 1100 520"
           style="width:100%; height:520px; border:1px solid #ddd; border-radius:12px; background:#fff;">
      </svg>

      <!-- Panel Estibas (aparece cuando eliges un bloque) -->
      <div id="stacksPanel" class="yard-overlay hidden">
        <div class="yard-overlay-card" style="max-width:980px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:800;">Estibas del bloque <span id="stacksBlockCode">â€”</span></div>
              <div style="font-size:12px; color:#555;">Verde = disponible Â· Rojo = lleno</div>
            </div>
            <button type="button" id="stacksCloseBtn" style="margin-top:0;">Cerrar</button>
          </div>

          <div id="stacksGrid" class="yard-grid" style="margin-top:12px;">
            <!-- JS pinta estibas aquÃ­ -->
          </div>

          <div style="margin-top:10px; font-size:12px; color:#666;">
            Tip: toca/arrastra sobre una estiba <b>verde</b> para ver sus filas disponibles.
          </div>
        </div>
      </div>

      <!-- Panel Filas (aparece cuando eliges una estiba) -->
      <div id="rowsPanel" class="yard-overlay hidden">
        <div class="yard-overlay-card" style="max-width:980px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:800;">
                Filas Â· Bloque <span id="rowsBlockCode">â€”</span> Â· Estiba <span id="rowsStackCode">â€”</span>
              </div>
              <div style="font-size:12px; color:#555;">Rojo = fila con 4 niveles Â· Verde = admite mÃ¡s</div>
            </div>
            <button type="button" id="rowsCloseBtn" style="margin-top:0;">Cerrar</button>
          </div>

          <div id="rowsGrid" class="yard-grid" style="margin-top:12px;">
            <!-- JS pinta filas aquÃ­ -->
          </div>

          <!-- ConfirmaciÃ³n -->
          <div id="confirmBar" class="hidden"
               style="margin-top:12px; display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap;">
            <div style="font-size:13px;">
              Sugerido: <b id="suggestedSlot">â€”</b>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
              <button type="button" id="confirmPlacementBtn" style="margin-top:0;">Confirmar</button>
              <button type="button" id="cancelPlacementBtn" style="margin-top:0; background:#111;">Cancelar</button>
            </div>
          </div>

          <div style="margin-top:10px; font-size:12px; color:#666;">
            Tip: al soltar en una fila verde, el sistema asigna el <b>nivel exacto</b> automÃ¡ticamente.
          </div>
        </div>
      </div>
    </div>

    <p style="margin-top:10px; color:#444;">
      PC: selecciona contenedor â†’ arrastra â†’ bloque â†’ estiba â†’ fila â†’ confirmar.<br>
      Tablet/Celular: selecciona contenedor â†’ toca bloque â†’ toca estiba â†’ toca fila â†’ confirmar.
    </p>
  </div>
</div>

<script>
  window.YARD_INIT = {
    // ya NO dependemos de blockSelect para entrar al patio
    // pero mantenemos compatibilidad por si usas un bloque â€œdefaultâ€
    block: "{{ selected_block }}",
  };
</script>
<script src="{{ url_for('static', filename='js/yard_map.js') }}"></script>
{% endblock %}

